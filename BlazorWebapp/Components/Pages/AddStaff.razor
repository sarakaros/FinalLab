@page "/addStaff"
@rendermode InteractiveServer

@inject Data.StaffService StaffService
@inject NavigationManager NavManager

<PageTitle>Add New Staff</PageTitle>

<h1>Add New Staff</h1>

<EditForm Model="newStaff" OnValidSubmit="HandleSubmit" FormName="AddStaffForm">
    
    @if (!string.IsNullOrEmpty(errorMessage))
    {
        <div class="alert alert-danger" data-testid="error-message-display">@errorMessage</div>
    }

    <div class="mb-3">
        <label class="form-label">Staff ID:</label>
        <InputText @bind-Value="newStaff.Id" class="form-control" data-testid="staff-id-input" />
    </div>
    
    <div class="mb-3">
        <label class="form-label">Staff Name:</label>
        <InputText @bind-Value="newStaff.Name" class="form-control" data-testid="staff-name-input" />
    </div>

    <div class="mb-3">
        <label class="form-label">Email:</label>
        <InputText @bind-Value="newStaff.Email" class="form-control" data-testid="email-input" />
    </div>

    <div class="mb-3">
        <label class="form-label">Phone:</label>
        <InputText @bind-Value="newStaff.Phone" class="form-control" data-testid="phone-input" />
    </div>

    <div class="mb-3">
        <label class="form-label">Start Date:</label>
        <InputDate @bind-Value="newStaff.StartingDate" class="form-control" data-testid="start-date-input" />
    </div>

    <div class="mb-3">
        <label class="form-label">Photo URL:</label>
        <InputText @bind-Value="newStaff.PhotoUrl" class="form-control" data-testid="photo-url-input" />
    </div>

    <button type="submit" class="btn btn-success" data-testid="submit-button">Add Staff Member</button>
    <div class="mb-3"></div>

</EditForm>


@code {
    private Staff newStaff = new Staff();
    private string errorMessage = string.Empty;
    private const string DefaultPhotoUrl = "https://thumbs.dreamstime.com/b/default-avatar-profile-icon-vector-social-media-user-portrait-176256935.jpg";

    private void HandleSubmit()
    {
        errorMessage = string.Empty;

        if (string.IsNullOrEmpty(newStaff.Id))
        {
            errorMessage = "Staff ID cannot be empty.";
            return;
        }
        if (string.IsNullOrEmpty(newStaff.Name))
        {
            errorMessage = "Staff Name cannot be empty.";
            return;
        }
        if (string.IsNullOrEmpty(newStaff.Email))
        {
            errorMessage = "Email cannot be empty.";
            return;
        }
        if (string.IsNullOrEmpty(newStaff.Phone))
        {
            errorMessage = "Phone cannot be empty.";
            return;
        }

        if (!StaffService.ValidateEmail(newStaff.Email))
        {
            errorMessage = "Invalid email format.";
            return;
        }
        if (!StaffService.ValidatePhone(newStaff.Phone))
        {
            errorMessage = "Invalid phone format. (e.g., +1 123 456 7890)";
            return;
        }

        if (!StaffService.IsIdUnique(newStaff.Id))
        {
            errorMessage = "This Staff ID is already in use. Please enter a unique one.";
            return;
        }
        if (!StaffService.IsEmailUnique(newStaff.Email))
        {
            errorMessage = "This Email is already in use by another staff member.";
            return;
        }
        if (!StaffService.IsPhoneUnique(newStaff.Phone))
        {
            errorMessage = "This Phone number is already in use by another staff member.";
            return;
        }

        if (string.IsNullOrEmpty(newStaff.PhotoUrl))
        {
            newStaff.PhotoUrl = DefaultPhotoUrl;
        }

        StaffService.AddNewStaff(newStaff);
        NavManager.NavigateTo("/");
    }
}